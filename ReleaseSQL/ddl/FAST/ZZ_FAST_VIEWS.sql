-- ALL FIELDS
--SELECT 
--	LISTAGG(''''||vw005.FIELD_ID||'''', ',') WITHIN GROUP (ORDER BY vw005.SUBMISSION_ID
--	, vw005.SECTION_ORD
--	, vw005.FIELD_ORD
--	, vw005.OPT_ORD)
--FROM 
--	VW005_DATA_FLAT_RAW vw005
--WHERE vw005.SUBMISSION_ID = 5
--
-- Contact / BIO fields
--SELECT 
--	LISTAGG(''''||vw005.FIELD_ID||'''', ',') WITHIN GROUP (ORDER BY vw005.SUBMISSION_ID
--	, vw005.SECTION_ORD
--	, vw005.FIELD_ORD
--	, vw005.OPT_ORD)
--FROM 
--	VW005_DATA_FLAT_RAW vw005
--WHERE vw005.SUBMISSION_ID = 5
--	AND vw005.section_ord IN (1,2)
--;
--
-- Other fields
--SELECT 
--	LISTAGG(''''||vw005.FIELD_ID||'''', ',') WITHIN GROUP (ORDER BY vw005.SUBMISSION_ID
--	, vw005.SECTION_ORD
--	, vw005.FIELD_ORD
--	, vw005.OPT_ORD)
--FROM 
--	VW005_DATA_FLAT_RAW vw005
--WHERE vw005.SUBMISSION_ID = 5
--	AND vw005.section_ord NOT IN (1,2);


CREATE OR REPLACE VIEW VW003_FIELD_LOOKUP AS
SELECT 
	yy009.FIELD_ID
	, yy005.FIELD_TYPE_CD
	, yy004.SECTION_CD
	, yy009.DISPLAY_SRT AS FIELD_ORDER	
	, CASE WHEN yy005.FIELD_SET_ID IS NOT NULL AND upper(yy005.FIELD_TYPE_CD) =  upper(N'checkbox') AND yy017.FIELD_RELATED_CD IS NULL THEN	  yy009.FIELD_ID || '-'|| yy005.FIELD_SET_ID || '-' || ty008.FIELD_SET_VALUE_CD END AS multichoice_sel 
	, CASE 
		WHEN yy005.FIELD_SET_ID IS NOT NULL AND upper(yy005.FIELD_TYPE_CD) =  upper(N'checkbox') AND yy017.FIELD_RELATED_CD IS NULL THEN   ty002_lst.LABEL_TXT
		ELSE Nvl(ty002.LABEL_TXT, yy017.FIELD_RELATED_CD) 
	END AS LABEL_TXT
FROM 
	YY004_SECTION yy004 
LEFT JOIN YY009_SECTION_FIELD yy009 ON yy009.SECTION_ID = yy004.SECTION_ID
LEFT JOIN YY005_FIELD yy005 ON yy005.FIELD_ID = yy009.FIELD_ID
LEFT JOIN TY002_LABEL ty002 ON ty002.RESOURCE_ID = yy005.RESOURCE_ID
LEFT JOIN TY007_FIELD_SET ty007 ON ty007.FIELD_SET_ID = yy005.FIELD_SET_ID
LEFT JOIN TY002_LABEL ty002_fs ON ty002_fs.RESOURCE_ID = ty007.RESOURCE_ID AND ty002_fs.LANGUAGE_ID = 3
LEFT JOIN YY017_FIELD_RELATED yy017 ON yy017.FIELD_SOURCE_ID = yy005.FIELD_ID
LEFT JOIN TY008_FIELD_SET_VALUE ty008 ON ty008.FIELD_SET_ID = yy005.FIELD_SET_ID AND yy005.FIELD_TYPE_CD = 'checkbox'
LEFT JOIN TY002_LABEL ty002_lst ON ty002_lst.RESOURCE_ID = ty008.RESOURCE_ID AND ty002_lst.LANGUAGE_ID = 3
WHERE 1=1
	AND yy004.FORM_ID = 2
	AND ty002.LANGUAGE_ID = 3
ORDER BY 
	yy004.DISPLAY_SRT 	
 	, yy009.DISPLAY_SRT;

CREATE OR REPLACE VIEW VW005_DATA_FLAT_RAW AS
SELECT 
	 	yy014.SUBMISSION_ID
	 	, yy004.DISPLAY_SRT AS SECTION_ORD
		, yy009.DISPLAY_SRT AS FIELD_ORD
		, nvl(ty008.DISPLAY_SRT, 0) AS OPT_ORD
	 	, CASE 
	 		WHEN ty008.FIELD_SET_VALUE_CD IS NOT NULL THEN yy009.FIELD_ID || '-' || ty008.FIELD_SET_ID || '-' || ty008.FIELD_SET_VALUE_CD
	 		ELSE TO_CHAR(yy009.FIELD_ID)
	 	  END AS FIELD_ID
		, CASE
			WHEN ty008.FIELD_SET_VALUE_CD IS NOT NULL THEN TO_NCHAR(Nvl(yy016.SELECTED_IND, 0))
			ELSE yy012.FIELD_RESPONSE_TXT
		  END AS FIELD_RESPONSE_TXT
	FROM 
		YY014_SUBMISSION yy014
	LEFT JOIN YY004_SECTION yy004 ON yy004.FORM_ID = yy014.FORM_ID
	LEFT JOIN YY009_SECTION_FIELD yy009 ON yy009.SECTION_ID = yy004.SECTION_ID
	LEFT JOIN YY012_FIELD_RESPONSE yy012 ON yy012.SUBMISSION_ID = yy014.SUBMISSION_ID  and yy012.SECTION_ID = yy004.SECTION_ID AND yy012.FIELD_ID = yy009.FIELD_ID
	LEFT JOIN YY005_FIELD yy005 ON yy005.FIELD_ID = yy009.FIELD_ID
	LEFT JOIN TY008_FIELD_SET_VALUE ty008 ON ty008.FIELD_SET_ID = yy005.FIELD_SET_ID AND yy005.FIELD_TYPE_CD = 'checkbox'
	LEFT JOIN YY016_FIELD_SET_RESPONSE yy016 ON yy016.SUBMISSION_ID = yy014.SUBMISSION_ID AND yy016.SECTION_ID = yy004.SECTION_ID AND yy016.FIELD_ID = yy005.FIELD_ID AND yy016.FIELD_SET_ID = ty008.FIELD_SET_ID AND yy016.FIELD_SET_VALUE_CD = ty008.FIELD_SET_VALUE_CD
	WHERE yy004.FORM_ID = 2 AND yy014.COMPLETE_IND = 1
	ORDER BY 
		yy014.SUBMISSION_ID
	 	, yy004.DISPLAY_SRT 	
	 	, yy009.DISPLAY_SRT
	 	, nvl(ty008.DISPLAY_SRT, 0)
	 ;
	 
CREATE OR REPLACE VIEW VW006_SUBMISSION_COMPLETE AS
SELECT 
	yy014.SUBMISSION_ID,
	yy014.DATE_LAST_UPDATE_DTE AS LAST_SUBMISSION_DTE
FROM 
	YY014_SUBMISSION yy014
WHERE yy014.FORM_ID = 2 AND yy014.COMPLETE_IND = 1;


CREATE OR REPLACE VIEW VW004_DATA_ALL AS
SELECT * FROM (
	SELECT 
		vw005.SUBMISSION_ID
		, vw005.FIELD_ID
		, vw005.FIELD_RESPONSE_TXT
	FROM 
		VW005_DATA_FLAT_RAW vw005
)
PIVOT (
	MAX(FIELD_RESPONSE_TXT)
	  FOR FIELD_ID
	  IN (
	        '4','5','6','7','8','9','10','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30','31','32','34','35','36-1-1-diversification','36-1-2-under-used','36-1-3-bottlenecks','36-1-14-improving','36-1-4-highway','36-1-5-conflicts','36-1-7-first','36-1-8-weather','36-1-9-hampering-northern','36-1-10-hampering-safety','36-1-11-vulnerabilities','36-1-12-providing','36-1-13-other','58','59-2-1-agriculture','59-2-2-energy','59-2-3-manufacturing','59-2-4-forestry','59-2-5-mining','59-2-6-transportation','59-2-7-other','60','61-3-2-AB','61-3-1-BC','61-3-4-MB','61-3-7-NB','61-3-10-NL','61-3-12-NT','61-3-9-NS','61-3-13-NU','61-3-5-ON','61-3-8-PE','61-3-6-QC','61-3-3-SK','61-3-11-YT','62','63-4-1-international','63-4-2-north','63-4-3-domestic','63-4-4-other','64','65-5-1-asia','65-5-2-europe','65-5-3-usa','65-5-4-middle','65-5-5-latin','65-5-6-other','66','90-3-2-AB','90-3-1-BC','90-3-4-MB','90-3-7-NB','90-3-10-NL','90-3-12-NT','90-3-9-NS','90-3-13-NU','90-3-5-ON','90-3-8-PE','90-3-6-QC','90-3-3-SK','90-3-11-YT','91','71-8-1-existing','71-8-2-prospective','71-8-3-both','72','37','38','39','40','41','42','235','43','194','195','196','197','198','199','220','200','201','202-29-1-secure','203','204-29-1-secure','274','221','205','206','207-29-1-secure','208','209-29-1-secure','275','222','210','211','212-29-1-secure','213','214-29-1-secure','276','223','215','216','217-29-1-secure','218','219-29-1-secure','277'
	    )
);

CREATE OR REPLACE VIEW VW002_SUBMISSION_PIVOT AS
SELECT * FROM (
	SELECT 
		vw005.SUBMISSION_ID
		, vw005.FIELD_ID
		, vw005.FIELD_RESPONSE_TXT
	FROM 
		VW005_DATA_FLAT_RAW vw005
)
PIVOT (
	MAX(FIELD_RESPONSE_TXT)
	  FOR FIELD_ID
	  IN (
	        '25','26','27','28','29','30','31','32','34','35','36-1-1-diversification','36-1-2-under-used','36-1-3-bottlenecks','36-1-14-improving','36-1-4-highway','36-1-5-conflicts','36-1-7-first','36-1-8-weather','36-1-9-hampering-northern','36-1-10-hampering-safety','36-1-11-vulnerabilities','36-1-12-providing','36-1-13-other','58','59-2-1-agriculture','59-2-2-energy','59-2-3-manufacturing','59-2-4-forestry','59-2-5-mining','59-2-6-transportation','59-2-7-other','60','61-3-2-AB','61-3-1-BC','61-3-4-MB','61-3-7-NB','61-3-10-NL','61-3-12-NT','61-3-9-NS','61-3-13-NU','61-3-5-ON','61-3-8-PE','61-3-6-QC','61-3-3-SK','61-3-11-YT','62','63-4-1-international','63-4-2-north','63-4-3-domestic','63-4-4-other','64','65-5-1-asia','65-5-2-europe','65-5-3-usa','65-5-4-middle','65-5-5-latin','65-5-6-other','66','90-3-2-AB','90-3-1-BC','90-3-4-MB','90-3-7-NB','90-3-10-NL','90-3-12-NT','90-3-9-NS','90-3-13-NU','90-3-5-ON','90-3-8-PE','90-3-6-QC','90-3-3-SK','90-3-11-YT','91','71-8-1-existing','71-8-2-prospective','71-8-3-both','72','37','38','39','40','41','42','235','43','194','195','196','197','198','199','220','200','201','202-29-1-secure','203','204-29-1-secure','274','221','205','206','207-29-1-secure','208','209-29-1-secure','275','222','210','211','212-29-1-secure','213','214-29-1-secure','276','223','215','216','217-29-1-secure','218','219-29-1-secure','277'
	    )
);



CREATE OR REPLACE VIEW VW001_CONTACT_PIVOT AS
SELECT * FROM (
	SELECT 
		vw005.SUBMISSION_ID
		, vw005.FIELD_ID
		, vw005.FIELD_RESPONSE_TXT
	FROM 
		VW005_DATA_FLAT_RAW vw005
)
PIVOT (
	MAX(FIELD_RESPONSE_TXT)
	  FOR FIELD_ID
	  IN (
	        '4','5','6','7','8','9','10','13','14','15','16','17','18','19','20','21','22','23','24'
	    )
);